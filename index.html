<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ‹ç‘ç•«å»Š v7.1 - æ¨¡çµ„åŒ–ç³»çµ±</title>
    <style>
        /* åŸºç¤æ¨£å¼ä¿æŒç°¡æ½” */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 550px; margin-bottom: 15px; box-sizing: border-box; }
        h2, h3 { text-align: center; color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccd1d9; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        .row { display: flex; gap: 8px; align-items: center; }
        .live-price-box { background: #fff; padding: 15px; border-radius: 10px; text-align: center; border: 2px dashed #e67e22; margin: 10px 0; }
        .live-price-val { font-size: 32px; font-weight: bold; color: #e67e22; }
        .btn-add { background: #27ae60; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-checkout { background: #2c3e50; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .inv-panel { background: #2c3e50; color: white; padding: 15px; border-radius: 15px; width: 100%; max-width: 550px; }
        .hidden { display: none !important; }
        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: none; width: 100%; } }
    </style>
</head>
<body>

<div class="card no-print" id="clientModule">
    <h3>ğŸ‘¤ å®¢æˆ¶è³‡è¨Š</h3>
    <div class="row">
        <input type="text" id="cust_name" placeholder="å®¢æˆ¶å§“å">
        <input type="tel" id="cust_phone" placeholder="é›»è©±">
    </div>
    <div class="row" style="margin-top:10px;">
        <div style="flex:1;"><label>æ”¶ä»¶æ—¥</label><input type="date" id="date_receive"></div>
        <div style="flex:1;"><label>é è¨ˆäº¤ä»¶</label><input type="date" id="date_deliver"></div>
    </div>
</div>

<div class="card no-print" id="quoteModule">
    <h3>ğŸ’° å ±åƒ¹è¨ˆç®—</h3>
    <div class="section">
        <label>å ±åƒ¹æ¨¡å¼</label>
        <select id="mode" onchange="toggleMode()">
            <option value="normal">åœ‹ç•«è£æ¡†</option>
            <option value="oil">æ²¹ç•«è£æ¡†</option>
            <option value="board">åœ‹ç•«è£±æ¿</option>
            <option value="scroll">ç«‹è»¸æ›è»¸</option>
        </select>
    </div>

    <div class="row">
        <div style="flex:1;"><label>é•· (ä¸‰ä½æ•¸)</label><input type="number" id="L_in" oninput="runCalc()" inputmode="numeric"></div>
        <div style="flex:1;"><label>å¯¬ (ä¸‰ä½æ•¸)</label><input type="number" id="W_in" oninput="runCalc()" inputmode="numeric"></div>
    </div>

    <div class="section" style="background:#eef7ff; padding:10px; border-radius:8px; margin-top:10px;">
        <label>ğŸ› ï¸ åº«å­˜æ‰£æ–™é€£çµ</label>
        <select id="linkInv">
            <option value="none">-- åƒ…è¨ˆç®—ï¼Œä¸æ‰£æ–™ --</option>
            <option value="frame_1">1å¯¸2åœ‹ç•«æ¡† (å’–å•¡è‰²)</option>
            <option value="frame_2">å°æ–°ï¼¢1 (å’–å•¡è‰²)</option>
        </select>
        <label style="margin-top:10px;"><input type="checkbox" id="linkAcy" onchange="runCalc()"> ä½¿ç”¨å£“å…‹åŠ›æ¿æ‰£æ–™</label>
    </div>

    <div class="live-price-box">
        <div class="live-price-val">NT$ <span id="priceTxt">0</span></div>
        <small id="sizeDetail" style="color:#7f8c8d;"></small>
    </div>
    <button class="btn-add" onclick="addItem()">ï¼‹ åŠ å…¥è¨‚å–®æ¸…å–®</button>
</div>

<div class="card" id="cartModule">
    <h3>ğŸ“ å ±åƒ¹æ¸…å–®</h3>
    <div id="printClient" class="hidden" style="margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:10px;"></div>
    <table style="width:100%;" id="cartTable"></table>
    <div style="text-align:right; font-size:20px; font-weight:bold; margin-top:15px; border-top:2px solid #2c3e50; padding-top:10px;">
        ç¸½è¨ˆï¼šNT$ <span id="totalTxt">0</span>
    </div>
    <button id="finalBtn" class="btn-checkout no-print" onclick="processCheckout()">ç¢ºèªçµå–® (æ‰£é™¤åº«å­˜)</button>
    <button class="btn-checkout no-print" style="background:#3498db;" onclick="window.print()">åˆ—å°å–®æ“š</button>
</div>

<div class="inv-panel no-print">
    <h3>ğŸ“¦ åº«å­˜å„€è¡¨æ¿</h3>
    <div id="invList"></div>
    <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
        <select id="addType" style="background:#34495e; color:white; border:none; padding:5px;"><option value="frame_1">1å¯¸2æ¡†</option><option value="frame_2">å°æ–°B1</option><option value="acy_36">3X6å£“å…‹åŠ›</option><option value="acy_48">4X8å£“å…‹åŠ›</option></select>
        <input type="number" id="addQty" placeholder="æ•¸é‡" style="width:80px; padding:5px; border-radius:5px;">
        <button onclick="handleRestock()" style="background:#27ae60; color:white; border:none; padding:5px 15px; border-radius:5px;">é€²è²¨</button>
    </div>
</div>

<script>
    // --- é…ç½®å€ ---
    const TG_TOKEN = '8025147107:AAFdsvl4GOUs9AVH1h6n-Lpe8i75liMIPik';
    const TG_CHAT_ID = '1135952609';
    const TAI_TO_CM = 30.3;

    // --- åº«å­˜åˆå§‹åŒ– (æ¨¡çµ„åŒ–è³‡æ–™) ---
    let invData = JSON.parse(localStorage.getItem('weray_inv_v7')) || {
        frame_1: { name: "1å¯¸2åœ‹ç•«æ¡†", qty: 200, unit: "å°º", min: 30 },
        frame_2: { name: "å°æ–°ï¼¢1", qty: 200, unit: "å°º", min: 30 },
        acy_36: { name: "å£“å…‹åŠ› 3X6", qty: 10, unit: "å¼µ", min: 5 },
        acy_48: { name: "å£“å…‹åŠ› 4X8", qty: 10, unit: "å¼µ", min: 5 }
    };

    let cart = [];
    let currentPrice = 0;

    // --- è¨ˆç®—æ¨¡çµ„ (åŸºæ–¼ v6.0 å…¬å¼) ---
    function runCalc() {
        const L = (parseFloat(document.getElementById('L_in').value) || 0) / 100;
        const W = (parseFloat(document.getElementById('W_in').value) || 0) / 100;
        const mode = document.getElementById('mode').value;
        
        if (L <= 0 || W <= 0) { currentPrice = 0; updateUI(); return; }

        // ç°¡åŒ–ç¤ºç¯„é‚è¼¯ (å¯åœ¨æ­¤è™•æ›å…¥æ‚¨ 6.0 çš„æ²¹ç•«/åœ‹ç•«è©³ç´°å…¬å¼)
        const tL = L + 1.0; const tW = W + 0.5;
        currentPrice = Math.round((tL + tW) * 250);
        
        document.getElementById('sizeDetail').innerText = `æ¡†å…§ï¼š${(tL*TAI_TO_CM).toFixed(1)}x${(tW*TAI_TO_CM).toFixed(1)} cm`;
        updateUI();
    }

    function updateUI() { document.getElementById('priceTxt').innerText = currentPrice.toLocaleString(); }

    function addItem() {
        if (currentPrice <= 0) return;
        const L = (parseFloat(document.getElementById('L_in').value) || 0) / 100;
        const W = (parseFloat(document.getElementById('W_in').value) || 0) / 100;
        cart.push({
            name: document.getElementById('mode').options[document.getElementById('mode').selectedIndex].text,
            price: currentPrice,
            len: (L + W + 1.5) * 2, // é è¨ˆæ¶ˆè€—å°ºæ•¸
            invKey: document.getElementById('linkInv').value,
            acyKey: document.getElementById('linkAcy').checked ? ((L*W*144 > 18) ? 'acy_48' : 'acy_36') : null
        });
        renderCart();
    }

    function renderCart() {
        const table = document.getElementById('cartTable');
        table.innerHTML = ""; let total = 0;
        cart.forEach((it, idx) => {
            total += it.price;
            table.innerHTML += `<tr><td style="padding:5px;">${it.name}</td><td align="right">${it.price.toLocaleString()}</td><td align="right"><button onclick="cart.splice(${idx},1);renderCart()" style="color:red; background:none; border:none;">âŒ</button></td></tr>`;
        });
        document.getElementById('totalTxt').innerText = total.toLocaleString();
    }

    // --- åº«å­˜èˆ‡çµå–®æ¨¡çµ„ ---
    async function processCheckout() {
        if (cart.length === 0) return alert("æ¸…å–®æ˜¯ç©ºçš„");
        
        let alerts = [];
        cart.forEach(it => {
            if (it.invKey !== 'none') invData[it.invKey].qty -= it.len;
            if (it.acyKey) invData[it.acyKey].qty -= 1;
        });

        // æª¢æŸ¥è­¦å ±
        for (let key in invData) {
            if (invData[key].qty < invData[key].min) {
                alerts.push(`ã€${invData[key].name}ã€‘å‰©é¤˜ ${invData[key].qty.toFixed(1)}${invData[key].unit}`);
            }
        }

        saveData();
        renderInv();

        if (alerts.length > 0) {
            await sendTG("âš ï¸ åº«å­˜ä¸è¶³è­¦å‘Šï¼š\n" + alerts.join("\n"));
            alert("çµå–®å®Œæˆï¼åº«å­˜åä½ï¼Œå·²ç™¼é€ Telegram é€šçŸ¥å¸«å‚…ã€‚");
        } else {
            alert("çµå–®å®Œæˆï¼Œåº«å­˜å·²è‡ªå‹•æ‰£é™¤ã€‚");
        }
        document.getElementById('finalBtn').classList.add('hidden');
    }

    function handleRestock() {
        const key = document.getElementById('addType').value;
        const val = parseFloat(document.getElementById('addQty').value) || 0;
        invData[key].qty += val;
        saveData(); renderInv();
        alert("é€²è²¨å®Œæˆï¼");
    }

    function saveData() { localStorage.setItem('weray_inv_v7', JSON.stringify(invData)); }

    function renderInv() {
        const div = document.getElementById('invList');
        div.innerHTML = "";
        for (let key in invData) {
            const it = invData[key];
            const low = it.qty < it.min;
            div.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #444;">
                <span>${it.name}</span><span style="${low?'color:#ff7675;font-weight:bold':''}">${it.qty.toFixed(1)} ${it.unit}</span>
            </div>`;
        }
    }

    async function sendTG(msg) {
        const url = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(msg)}`;
        return fetch(url).catch(e => console.error(e));
    }

    function toggleMode() { runCalc(); }

    window.onload = function() {
        const today = new Date();
        document.getElementById('date_receive').value = today.toISOString().split('T')[0];
        renderInv();
    };
</script>
</body>
</html>
