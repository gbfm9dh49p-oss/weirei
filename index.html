<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ‹ç‘ç•«å»Š v7.0 - åº«å­˜é€£å‹•ç‰ˆ</title>
    <style>
        /* æ‰¿è¥² v6.0 æ¨£å¼ä¸¦æ–°å¢åº«å­˜å°ˆç”¨æ¨£å¼ */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 550px; margin-bottom: 15px; box-sizing: border-box; }
        h2, h3 { text-align: center; color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccd1d9; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 8px; align-items: center; }
        .live-price-box { background: #fff; padding: 15px; border-radius: 10px; text-align: center; border: 2px dashed #e67e22; margin: 10px 0; }
        .live-price-val { font-size: 32px; font-weight: bold; color: #e67e22; }
        .btn-add { background-color: #27ae60; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-checkout { background-color: #2c3e50; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* åº«å­˜å„€è¡¨æ¿æ¨£å¼ */
        .inventory-panel { background: #2c3e50; color: white; padding: 15px; border-radius: 15px; width: 100%; max-width: 550px; margin-top: 20px; }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #3e4f5f; }
        .inv-low { color: #ff7675; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .hidden { display: none !important; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="card no-print" id="inputSection">
    <h2>éŸ‹ç‘ç•«å»Š v7.0</h2>
    
    <div class="section" style="background: #fcfcfc; border: 1px solid #eee; padding: 15px; border-radius: 10px;">
        <label>ğŸ‘¤ å®¢æˆ¶è³‡æ–™</label>
        <div class="row"><input type="text" id="cust_name" placeholder="å§“å"><input type="tel" id="cust_phone" placeholder="é›»è©±"></div>
    </div>

    <div class="section">
        <label>å ±åƒ¹æ¨¡å¼</label>
        <select id="mode" onchange="toggleMode()">
            <option value="oil">æ²¹ç•«è£æ¡†</option>
            <option value="normal" selected>åœ‹ç•«è£æ¡†</option>
            <option value="board">åœ‹ç•«è£±æ¿</option>
        </select>
    </div>

    <div id="size-inputs">
        <div class="row">
            <div class="section"><label>ç•«å¿ƒé•· (ä¸‰ä½æ•¸)</label><input type="number" id="L_input" placeholder="å¦‚ 300" oninput="calculateLive()" inputmode="numeric"></div>
            <div class="section"><label>ç•«å¿ƒå¯¬ (ä¸‰ä½æ•¸)</label><input type="number" id="W_input" placeholder="å¦‚ 600" oninput="calculateLive()" inputmode="numeric"></div>
        </div>
        
        <div class="section" style="background:#e8f4fd; padding:10px; border-radius:8px;">
            <label>é€£çµåº«å­˜æ‰£æ–™ (é¸å¡«)</label>
            <select id="invLink">
                <option value="none">-- åƒ…å ±åƒ¹ï¼Œä¸æ‰£åº«å­˜ --</option>
                <option value="frame_1">1å¯¸2åœ‹ç•«æ¡† (å’–å•¡è‰²)</option>
                <option value="frame_2">å°æ–°ï¼¢1 (å’–å•¡è‰²)</option>
            </select>
            <div class="row" style="margin-top:5px;">
                <label style="font-size:12px;"><input type="checkbox" id="useAcy" onchange="calculateLive()"> ä½¿ç”¨å£“å…‹åŠ›æ‰£æ–™</label>
            </div>
        </div>
    </div>

    <div class="live-price-box">
        <div class="live-price-val">NT$ <span id="liveTotal">0</span></div>
    </div>

    <button class="btn-add" onclick="addToCart()">ï¼‹ åŠ å…¥è¨‚å–®æ¸…å–®</button>
</div>

<div class="card" id="cartSection">
    <h3>å ±åƒ¹æ¸…å–®</h3>
    <table style="width:100%;" id="cartTable"></table>
    <div style="text-align:right; font-size:20px; font-weight:bold; margin-top:10px;">ç¸½è¨ˆï¼šNT$ <span id="grandTotal">0</span></div>
    <button id="confirmBtn" class="btn-checkout no-print" onclick="checkoutAndDeduct()">ç¢ºèªçµå–® (è‡ªå‹•æ‰£æ–™)</button>
    <button class="btn-checkout no-print" style="background:#3498db;" onclick="window.print()">åˆ—å°å–®æ“š</button>
    <button id="resetBtn" class="btn-checkout hidden no-print" onclick="location.reload()">ä¸‹ä¸€å¼µæ–°è¨‚å–®</button>
</div>

<div class="inventory-panel no-print">
    <h3>ğŸ“¦ åº«å­˜å„€è¡¨æ¿</h3>
    <div id="invDisplay"></div>
    <div style="margin-top:15px; border-top:1px solid #555; padding-top:10px;">
        <label style="color:#bdc3c7;">å¿«é€Ÿé€²è²¨ (é»é¸å‹è™Ÿå¾Œå¡«å¯«)</label>
        <div class="row">
            <select id="restockItem" style="background:#34495e; color:white;">
                <option value="frame_1">1å¯¸2åœ‹ç•«æ¡†</option>
                <option value="frame_2">å°æ–°ï¼¢1</option>
                <option value="acy_36">å£“å…‹åŠ› 3X6</option>
                <option value="acy_48">å£“å…‹åŠ› 4X8</option>
            </select>
            <input type="number" id="restockQty" placeholder="æ•¸é‡" style="width:100px;">
            <button onclick="restock()" style="padding:10px; border-radius:8px; border:none; background:#27ae60; color:white;">é€²è²¨</button>
        </div>
    </div>
</div>

<script>
    // --- Telegram è¨­å®š ---
    const TG_TOKEN = '8025147107:AAFdsvl4GOUs9AVH1h6n-Lpe8i75liMIPik'; // é€™è£¡å¡«å…¥æ‚¨ç”³è«‹çš„ Token
    const TG_CHAT_ID = '1135952609'; // é€™è£¡å¡«å…¥æ‚¨çš„ Chat ID

    // --- åˆå§‹åº«å­˜è³‡æ–™ ---
    let inventory = JSON.parse(localStorage.getItem('weray_inv')) || {
        frame_1: { name: "1å¯¸2åœ‹ç•«æ¡†", qty: 100, unit: "å°º", min: 30 },
        frame_2: { name: "å°æ–°ï¼¢1", qty: 100, unit: "å°º", min: 30 },
        acy_36: { name: "å£“å…‹åŠ› 3X6", qty: 10, unit: "å¼µ", min: 5 },
        acy_48: { name: "å£“å…‹åŠ› 4X8", qty: 10, unit: "å¼µ", min: 5 }
    };

    let cart = [];
    let livePrice = 0;

    function calculateLive() {
        const Lt = (parseFloat(document.getElementById('L_input').value) || 0) / 100;
        const Wt = (parseFloat(document.getElementById('W_input').value) || 0) / 100;
        if(Lt > 0 && Wt > 0) {
            livePrice = Math.round((Lt + Wt + 1.5) * 250); // ç°¡åŒ–ç¤ºç¯„å…¬å¼
            document.getElementById('liveTotal').innerText = livePrice.toLocaleString();
        }
    }

    function addToCart() {
        if(livePrice <= 0) return;
        const Lt = (parseFloat(document.getElementById('L_input').value) || 0) / 100;
        const Wt = (parseFloat(document.getElementById('W_input').value) || 0) / 100;
        const item = {
            title: document.getElementById('invLink').options[document.getElementById('invLink').selectedIndex].text,
            price: livePrice,
            len: (Lt + Wt) * 2, // å¯¦éš›æ¶ˆè€—é•·åº¦
            invKey: document.getElementById('invLink').value,
            useAcy: document.getElementById('useAcy').checked,
            acyType: (Lt * Wt * 11.93 * 11.93 / 144) > 18 ? 'acy_48' : 'acy_36'
        };
        cart.push(item);
        renderCart();
    }

    function renderCart() {
        const table = document.getElementById('cartTable');
        table.innerHTML = ""; let total = 0;
        cart.forEach((it, idx) => {
            total += it.price;
            table.innerHTML += `<tr><td>${it.title}</td><td align="right">${it.price}</td></tr>`;
        });
        document.getElementById('grandTotal').innerText = total.toLocaleString();
    }

    // --- çµå–®ä¸¦æ‰£é™¤åº«å­˜ ---
    async function checkoutAndDeduct() {
        if(cart.length === 0) return alert("è¨‚å–®æ¸…å–®ç©ºç©ºå¦‚ä¹Ÿ");
        
        let alerts = [];
        cart.forEach(it => {
            // æ‰£æ¡†æ¢
            if(it.invKey !== 'none') {
                inventory[it.invKey].qty -= it.len;
            }
            // æ‰£å£“å…‹åŠ›
            if(it.useAcy) {
                inventory[it.acyType].qty -= 1;
            }
        });

        // æª¢æŸ¥æ˜¯å¦ä½æ–¼æ°´ä½
        for(let key in inventory) {
            if(inventory[key].qty < inventory[key].min) {
                alerts.push(`${inventory[key].name} åº«å­˜å‰©é¤˜ ${inventory[key].qty.toFixed(1)} ${inventory[key].unit}`);
            }
        }

        saveInv();
        renderInv();

        if(alerts.length > 0) {
            sendTelegram("âš ï¸ éŸ‹ç‘åº«å­˜è­¦å ±ï¼š\n" + alerts.join("\n"));
            alert("çµå–®æˆåŠŸï¼éƒ¨åˆ†ç‰©æ–™ä½æ–¼æ°´ä½ï¼Œå·²ç™¼é€ Telegram é€šçŸ¥å¸«å‚…ã€‚");
        } else {
            alert("çµå–®æˆåŠŸï¼Œåº«å­˜å·²è‡ªå‹•æ‰£é™¤ã€‚");
        }
        
        document.getElementById('confirmBtn').classList.add('hidden');
        document.getElementById('resetBtn').classList.remove('hidden');
    }

    function restock() {
        const key = document.getElementById('restockItem').value;
        const qty = parseFloat(document.getElementById('restockQty').value) || 0;
        inventory[key].qty += qty;
        saveInv(); renderInv();
        alert("é€²è²¨æˆåŠŸï¼");
    }

    function saveInv() { localStorage.setItem('weray_inv', JSON.stringify(inventory)); }

    function renderInv() {
        const div = document.getElementById('invDisplay');
        div.innerHTML = "";
        for(let key in inventory) {
            const item = inventory[key];
            const isLow = item.qty < item.min;
            div.innerHTML += `
                <div class="inv-item">
                    <span>${item.name}</span>
                    <span class="${isLow ? 'inv-low' : ''}">${item.qty.toFixed(1)} ${item.unit} ${isLow ? '(ä½)' : ''}</span>
                </div>`;
        }
    }

    async function sendTelegram(msg) {
        const url = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(msg)}`;
        try { await fetch(url); } catch(e) { console.error("TGå‚³é€å¤±æ•—", e); }
    }

    window.onload = function() { renderInv(); calculateLive(); };
</script>
</body>
</html>
